name: Nightly Build and Publish

on:
  schedule:
    # 每天晚上 17:00 UTC (北京时间 1:00) 运行
    - cron: '0 17 * * *'
  workflow_dispatch:  # 允许手动触发

env:
  ARCH: x86_64

jobs:
  build-and-publish:
    name: Build DragonOS and Publish Artifacts
    runs-on: ubuntu-latest
    timeout-minutes: 120
    container:
      image: dragonos/dragonos-dev:v1.19
      options: --privileged -v /dev:/dev
    services:
      docker:
        image: docker:dind
        options: --privileged
    steps:
      - name: Checkout DragonOS code
        uses: actions/checkout@v4

      - name: Change source
        run: |
          find . -type f \( -name "*.toml" -o -name "Makefile" \) -exec sed -i 's/git\.mirrors\.dragonos\.org\.cn/github\.com/g' {} +

      - name: Build DragonOS
        shell: bash -ileo pipefail {0}
        run: |
          make clean
          SKIP_GRUB=1 make build

      - name: Verify build artifacts
        shell: bash -ileo pipefail {0}
        run: |
          if [ ! -f "bin/kernel/kernel.elf" ]; then
            echo "错误: bin/kernel/kernel.elf 不存在"
            exit 1
          fi
          if [ ! -f "bin/disk-image-x86_64.img" ]; then
            echo "错误: bin/disk-image-x86_64.img 不存在"
            exit 1
          fi
          echo "构建产物验证成功"
          ls -lh bin/kernel/kernel.elf bin/disk-image-x86_64.img

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Generate image tag
        id: image-tag
        shell: bash -ileo pipefail {0}
        run: |
          DATE_TAG=$(date +%Y%m%d)
          COMMIT_SHORT=$(git rev-parse --short HEAD)
          REGISTRY_URL=docker.cnb.cool
          IMAGE_NAME=dragonos-community/playground/artifacts
          
          FULL_IMAGE_NAME="${REGISTRY_URL}/${IMAGE_NAME}"
          
          echo "tag=${FULL_IMAGE_NAME}:nightly-latest" >> "$GITHUB_OUTPUT"
          echo "Full image name: ${FULL_IMAGE_NAME}"

      - name: Login to container registry
        uses: docker/login-action@v2
        with:
          registry: docker.cnb.cool
          username: cnb
          password: ${{ secrets.CNB_PLAYGROUND_REGISTRY_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: tools/Dockerfile.artifacts
          platforms: linux/amd64
          push: true
          tags: |
            ${{ steps.image-tag.outputs.tag }}

