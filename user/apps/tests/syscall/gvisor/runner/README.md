# gvisorç³»ç»Ÿè°ƒç”¨æµ‹è¯•è¿è¡Œå™¨ (Rustç‰ˆæœ¬)

è¿™æ˜¯åŸShellè„šæœ¬ `run_tests.sh` çš„Rusté‡å†™ç‰ˆæœ¬ï¼Œç”¨äºåœ¨DragonOSä¸Šè¿è¡Œgvisorç³»ç»Ÿè°ƒç”¨æµ‹è¯•ã€‚

## åŠŸèƒ½ç‰¹ç‚¹

- ğŸš€ ä½¿ç”¨Rustç¼–å†™ï¼Œæ€§èƒ½æ›´å¥½ï¼Œé”™è¯¯å¤„ç†æ›´å®Œå–„
- ğŸ“‹ æ”¯æŒç™½åå•å’Œé»‘åå•æ¨¡å¼è¿‡æ»¤æµ‹è¯•
- â±ï¸ å¯é…ç½®çš„æµ‹è¯•è¶…æ—¶æ—¶é—´
- ğŸ“Š è¯¦ç»†çš„æµ‹è¯•æŠ¥å‘Šå’Œç»Ÿè®¡ä¿¡æ¯
- ğŸ¨ å½©è‰²è¾“å‡ºï¼Œæ˜“äºè¯†åˆ«æµ‹è¯•ç»“æœ
- ğŸ“ è‡ªåŠ¨åˆ›å»ºæµ‹è¯•ç›®å½•å’Œç»“æœæ–‡ä»¶

## æ„å»ºå’Œå®‰è£…

```bash
# è¿›å…¥runnerç›®å½•
cd user/apps/tests/syscall/gvisor/runner

# æ„å»ºé¡¹ç›®
cargo build --release

# äºŒè¿›åˆ¶æ–‡ä»¶ä½äº target/release/runner
```

## ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ç”¨æ³•

```bash
# è¿è¡Œç™½åå•ä¸­çš„æµ‹è¯•ç¨‹åº
./target/release/runner

# åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„æµ‹è¯•ç”¨ä¾‹
./target/release/runner --list

# è¯¦ç»†æ¨¡å¼è¿è¡Œæµ‹è¯•
./target/release/runner --verbose

# è®¾ç½®æµ‹è¯•è¶…æ—¶ä¸º180ç§’
./target/release/runner --timeout 180
```

### é«˜çº§é€‰é¡¹

```bash
# ç¦ç”¨ç™½åå•ï¼Œè¿è¡Œæ‰€æœ‰æµ‹è¯•
./target/release/runner --no-whitelist

# ç¦ç”¨é»‘åå•è¿‡æ»¤
./target/release/runner --no-blocklist

# ä½¿ç”¨è‡ªå®šä¹‰ç™½åå•æ–‡ä»¶
./target/release/runner --whitelist my_whitelist.txt

# æŒ‡å®šé¢å¤–çš„é»‘åå•ç›®å½•
./target/release/runner --extra-blocklist extra_blocks

# è¿è¡Œç‰¹å®šçš„æµ‹è¯•ç¨‹åº
./target/release/runner socket_test chdir_test

# è¯¦ç»†å¸®åŠ©
./target/release/runner --help
```

## é…ç½®æ–‡ä»¶

### ç™½åå•æ–‡ä»¶ (`whitelist.txt`)

```text
# gvisoræµ‹è¯•ç¨‹åºç™½åå•
# æ¯è¡Œä¸€ä¸ªæµ‹è¯•ç¨‹åºåç§°ï¼Œåªæœ‰åœ¨æ­¤åˆ—è¡¨ä¸­çš„æµ‹è¯•ç¨‹åºæ‰ä¼šè¢«æ‰§è¡Œ
# ä»¥#å¼€å¤´çš„è¡Œä¸ºæ³¨é‡Šï¼Œç©ºè¡Œä¼šè¢«å¿½ç•¥

# åŸºç¡€ç³»ç»Ÿè°ƒç”¨æµ‹è¯•
chdir_test
read_test

# æ–‡ä»¶ç³»ç»Ÿç›¸å…³æµ‹è¯•  
# stat_test  # è¢«æ³¨é‡Šæ‰çš„æµ‹è¯•ä¸ä¼šè¿è¡Œ
```

### é»‘åå•æ–‡ä»¶ (`blocklists/æµ‹è¯•åç§°`)

æ¯ä¸ªæµ‹è¯•ç¨‹åºéƒ½å¯ä»¥æœ‰å¯¹åº”çš„é»‘åå•æ–‡ä»¶ï¼Œç”¨äºå±è”½ç‰¹å®šçš„å­æµ‹è¯•ï¼š

```text
# epoll_testé»‘åå•æ–‡ä»¶ (blocklists/epoll_test)
# å±è”½çš„å­æµ‹è¯•åç§°ï¼Œæ¯è¡Œä¸€ä¸ª
EpollTest.Timeout_NoRandomSave  
EpollTest.CycleOfOneDisallowed
EpollTest.CycleOfThreeDisallowed
```

## ç›®å½•ç»“æ„

```
runner/
â”œâ”€â”€ Cargo.toml          # Rusté¡¹ç›®é…ç½®
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.rs         # ä¸»ç¨‹åºå…¥å£
â”‚   â””â”€â”€ lib_sync.rs     # åŒæ­¥ç‰ˆæœ¬çš„æ ¸å¿ƒåº“
â”œâ”€â”€ target/             # ç¼–è¯‘è¾“å‡ºç›®å½•
â”‚   â””â”€â”€ release/
â”‚       â””â”€â”€ runner      # æœ€ç»ˆå¯æ‰§è¡Œæ–‡ä»¶
â””â”€â”€ README.md          # æœ¬æ–‡ä»¶
```

## è¾“å‡ºæ–‡ä»¶

ç¨‹åºè¿è¡Œæ—¶ä¼šåœ¨ `results/` ç›®å½•ä¸‹ç”Ÿæˆä»¥ä¸‹æ–‡ä»¶ï¼š

- `test_report.txt` - å®Œæ•´çš„æµ‹è¯•æŠ¥å‘Š
- `failed_cases.txt` - å¤±è´¥çš„æµ‹è¯•ç”¨ä¾‹åˆ—è¡¨  
- `[æµ‹è¯•åç§°].output` - æ¯ä¸ªæµ‹è¯•çš„è¯¦ç»†è¾“å‡º

## ç¯å¢ƒå˜é‡

- `SYSCALL_TEST_WORKDIR` - ä¸´æ—¶å·¥ä½œç›®å½•è·¯å¾„ï¼ˆé»˜è®¤ï¼š`/tmp/gvisor_tests`ï¼‰

## ä¸Shellç‰ˆæœ¬çš„åŒºåˆ«

1. **æ€§èƒ½**: Rustç‰ˆæœ¬å¯åŠ¨æ›´å¿«ï¼Œå†…å­˜ä½¿ç”¨æ›´å°‘
2. **é”™è¯¯å¤„ç†**: æ›´å¥½çš„é”™è¯¯ä¿¡æ¯å’Œå¼‚å¸¸å¤„ç†
3. **å¹¶å‘**: ä¸ºæœªæ¥çš„å¹¶è¡Œæµ‹è¯•æ‰§è¡Œå‡†å¤‡äº†åŸºç¡€æ¶æ„
4. **å¯ç»´æŠ¤æ€§**: ç±»å‹å®‰å…¨ï¼Œæ›´å®¹æ˜“æ‰©å±•å’Œç»´æŠ¤
5. **ä¾èµ–**: å‡å°‘äº†å¯¹ç³»ç»Ÿå‘½ä»¤çš„ä¾èµ–

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æµ‹è¯•å¥—ä»¶æœªæ‰¾åˆ°**
   ```
   é”™è¯¯: æµ‹è¯•ç›®å½•ä¸å­˜åœ¨
   ```
   è§£å†³: å…ˆè¿è¡Œ `./download_tests.sh` ä¸‹è½½æµ‹è¯•å¥—ä»¶

2. **æƒé™é—®é¢˜**
   ```
   é”™è¯¯: æµ‹è¯•ä¸å­˜åœ¨æˆ–ä¸å¯æ‰§è¡Œ
   ```
   è§£å†³: ç¡®ä¿æµ‹è¯•æ–‡ä»¶æœ‰æ‰§è¡Œæƒé™ `chmod +x tests/*_test`

3. **è¶…æ—¶é—®é¢˜**
   ```
   é”™è¯¯: æµ‹è¯•è¶…æ—¶
   ```
   è§£å†³: ä½¿ç”¨ `--timeout` å‚æ•°å¢åŠ è¶…æ—¶æ—¶é—´

### è°ƒè¯•æ¨¡å¼

ä½¿ç”¨ `--verbose` å‚æ•°è·å¾—è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ï¼š

```bash
./target/release/runner --verbose --timeout 600 socket_test
```

## å¼€å‘è¯´æ˜

å¦‚æœéœ€è¦ä¿®æ”¹æˆ–æ‰©å±•åŠŸèƒ½ï¼š

1. ä¸»è¦é€»è¾‘åœ¨ `src/lib_sync.rs` ä¸­
2. å‘½ä»¤è¡Œå‚æ•°å¤„ç†åœ¨ `src/main.rs` ä¸­
3. ä½¿ç”¨ `cargo test` è¿è¡Œå•å…ƒæµ‹è¯•ï¼ˆå¦‚æœæœ‰ï¼‰
4. ä½¿ç”¨ `cargo fmt` æ ¼å¼åŒ–ä»£ç 
5. ä½¿ç”¨ `cargo clippy` è¿›è¡Œä»£ç æ£€æŸ¥

## è®¸å¯è¯

ä¸DragonOSé¡¹ç›®ä¿æŒä¸€è‡´çš„è®¸å¯è¯ã€‚